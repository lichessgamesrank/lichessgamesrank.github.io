const readStream=e=>t=>{let r=t.body.getReader(),n=/\r?\n/,l=new TextDecoder,a="",i=()=>r.read().then(({done:t,value:r})=>{if(t)a.length>0&&e(JSON.parse(a));else{let s=l.decode(r,{stream:!0});a+=s;let d=a.split(n);for(let c of(a=d.pop(),d.filter(e=>e)))e(JSON.parse(c));return i()}});return i()};let submit=document.getElementById("submit"),filterE=document.getElementById("filter"),config={rated:0,order:0,rank:0,from:0,to:Date.now(),op:""};function error(){document.getElementById("username").className="texti error",setTimeout(()=>{document.getElementById("username").className="texti",unblock()},3e3)}function block(){document.getElementById("username").disabled=!0,document.getElementById("submit").disabled=!0}function unblock(){document.getElementById("username").value="",document.getElementById("username").disabled=!1,document.getElementById("submit").disabled=!1}function tc(e){return({"0.25":"\xbd","0.5":"\xbc","0.75":"\xbe"})[e]?({"0.25":"\xbd","0.5":"\xbc","0.75":"\xbe"})[e]:e}function perf(e){return({ultraBullet:"UltraBullet",bullet:"Bullet",blitz:"Blitz",rapid:"Rapid",classical:"Classical",correspondence:"Correspondence",chess960:"Chess960",crazyhouse:"Crazyhouse",antichess:"Antichess",atomic:"Atomic",horde:"Horde",kingOfTheHill:"King of the Hill",racingKings:"Racing Kings",threeCheck:"Three-check",fromPosition:"From Position"})[e]}let games=[],user;filterE.addEventListener("click",async()=>{document.getElementById("filter").innerText=`Filters ${"▲"===document.getElementById("filter").innerText.split("").reverse()[0]?"▼":"▲"}`;let e=document.getElementById("filters");"none"!==e.style.display?e.style.display="none":e.style.display="block"}),submit.addEventListener("click",async()=>{block();let e=document.getElementById("username").value;if(""===e)error();else if((user=await (user=await fetch(`https://lichess.org/api/user/${e}`)).json()).disabled)document.getElementById("username").value="",error();else if(user.error)document.getElementById("username").value="",error();else{document.getElementById("table").innerHTML=`<a href="https://lichess.org/@/${user.username}"><b>${user.title?user.title+" ":""}${user.username}</b></a> games (0/${user.count.all})`;let t=fetch(`https://lichess.org/api/games/user/${e}?pgnInJson=true`,{headers:{Accept:"application/x-ndjson"}}),r=user.count.all,n=e=>{if(e.players.white.user&&e.players.black.user){e.players.white.user.id===user.id?e.players.white:e.players.black;let t=e.players.white.user.id===user.id?e.players.black:e.players.white;e.ad=t,games.push(e)}else r--;document.getElementById("table").innerHTML=`<a href="https://lichess.org/@/${user.username}"><b>${user.title?user.title+" ":""}${user.username}</b></a> games (${games.length}/${r})`},l=()=>{config.from=user.createdAt,games=(games=games.sort((e,t)=>e.ad.rating-t.ad.rating)).reverse();let e=0;for(let t=0;t<games.length;t++){let r=games[t],n=r.players.white.user.id===user.id?r.players.white:r.players.black,l=r.players.white.user.id===user.id?r.players.black:r.players.white;if(r.winner){if(r.players[r.winner].user.id===user.id){let a=document.createElement("tr"),i=document.createElement("td"),s=document.createElement("td"),d=document.createElement("td"),c=document.createElement("td"),o=document.createElement("td"),p=document.createElement("td"),g=document.createElement("td"),h=document.createElement("td"),u=new Date(r.createdAt);i.innerText=`${t+1-e}`,s.innerHTML=`<a href="https://lichess.org/@/${l.user.id}">${l.user.title?`<b class="title"${"BOT"===l.user.title?'style="color: #b72fc6;"':""}>${l.user.title}</b> `:""}${l.user.name}</a>`,d.innerText=`${l.rating}${l.provisional?"?":""}`,c.innerText=`${n.rating}${n.provisional?"?":""}`,o.innerHTML=`<a href="https://lichess.org/@/${user.username}${"fromPosition"===r.perf?"":`/perf/${r.perf}`}">${perf(r.perf)}`,p.innerText=r.daysPerTurn?`${r.daysPerTurn} ${r.daysPerTurn>1?"days":"day"}`:r.clock?`${tc(r.clock.initial/60)}+${r.clock.increment}`:"∞",g.innerText=`${r.rated?"Yes":"No"}`,h.innerHTML=`<a href="https://lichess.org/${r.id}">${u.getFullYear()}-${1===`${u.getMonth()+1}`.length?`0${u.getMonth()+1}`:u.getMonth()+1}-${1===`${u.getDate()}`.length?`0${u.getDate()}`:u.getDate()}</a>`,a.appendChild(i),a.appendChild(s),a.appendChild(d),a.appendChild(c),a.appendChild(o),a.appendChild(p),a.appendChild(g),a.appendChild(h),document.getElementById("tbody").appendChild(a)}else e++}else e++}document.getElementById("table").innerHTML=`<a href="https://lichess.org/@/${user.username}"><b>${user.title?user.title+" ":""}${user.username}</b></a> games`,filterE.style.display="block"};t.then(readStream(n)).then(l)}});let f_rc=document.getElementById("f_rc");f_rc.addEventListener("click",async()=>{document.getElementById("f_rc").innerText=`${({"Rated and Casual":"Rated",Rated:"Casual",Casual:"Rated and Casual"})[document.getElementById("f_rc").innerText]}`,config.rated=({"Rated and Casual":0,Rated:1,Casual:2})[document.getElementById("f_rc").innerText]});let f_or=document.getElementById("f_or");f_or.addEventListener("click",async()=>{document.getElementById("f_or").innerText=`${({Descending:"Ascending",Ascending:"Descending"})[document.getElementById("f_or").innerText]}`,config.order=({Descending:0,Ascending:1})[document.getElementById("f_or").innerText]});let f_r=document.getElementById("f_r");function update(){let e=document.getElementById("f_from"),t=document.getElementById("f_to");config.from=""===e.value?user.createdAt:new Date(e.value).getTime(),config.to=""===t.value?Date.now():new Date(t.value).getTime();let r=document.getElementById("f_name");for(config.op=r.value;document.getElementById("tbody").firstChild;)document.getElementById("tbody").firstChild.remove();let n=0,l=0,a=games;switch(a=(a=a.filter(e=>e.createdAt>config.from)).filter(e=>e.lastMoveAt<config.to),""!==config.op&&(a=a.filter(e=>e.ad.user.id===config.op.toLowerCase())),config.rated){case 1:a=a.filter(e=>!0===e.rated);break;case 2:a=a.filter(e=>!1===e.rated)}let i=["v_1","v_2","v_3","v_4","v_5","v_6","v_7","v_8","v_9","v_10","v_11","v_12","v_13","v_14"],s=["ultraBullet","bullet","blitz","rapid","classical","correspondence","chess960","crazyhouse","antichess","atomic","horde","kingOfTheHill","racingKings","threeCheck"];document.getElementById("variant").querySelectorAll("input").forEach(e=>{e.checked||(s=s.filter(t=>t!==s[i.indexOf(e.id)])),e.checked||(i=i.filter(t=>t!==e.id))}),a=a.filter(e=>s.includes(e.perf)),1===config.order&&(a=a.reverse());for(let d=0;d<a.length;d++){let c=a[d],o=c.players.white.user.id===user.id?c.players.white:c.players.black,p=c.players.white.user.id===user.id?c.players.black:c.players.white;switch(config.rank){case 0:if(c.winner){if(c.players[c.winner].user.id===user.id){let g=document.createElement("tr"),h=document.createElement("td"),u=document.createElement("td"),m=document.createElement("td"),f=document.createElement("td"),y=document.createElement("td"),E=document.createElement("td"),T=document.createElement("td"),b=document.createElement("td"),C=new Date(c.createdAt);h.innerText=`${d+1-n}`,u.innerHTML=`<a href="https://lichess.org/@/${p.user.id}">${p.user.title?`<b class="title"${"BOT"===p.user.title?'style="color: #b72fc6;"':""}>${p.user.title}</b> `:""}${p.user.name}</a>`,m.innerText=`${p.rating}${p.provisional?"?":""}`,f.innerText=`${o.rating}${o.provisional?"?":""}`,y.innerHTML=`<a href="https://lichess.org/@/${user.username}${"fromPosition"===c.perf?"":`/perf/${c.perf}`}">${perf(c.perf)}`,E.innerText=c.daysPerTurn?`${c.daysPerTurn} ${c.daysPerTurn>1?"days":"day"}`:c.clock?`${tc(c.clock.initial/60)}+${c.clock.increment}`:"∞",T.innerText=`${c.rated?"Yes":"No"}`,b.innerHTML=`<a href="https://lichess.org/${c.id}">${C.getFullYear()}-${1===`${C.getMonth()+1}`.length?`0${C.getMonth()+1}`:C.getMonth()+1}-${1===`${C.getDate()}`.length?`0${C.getDate()}`:C.getDate()}</a>`,g.appendChild(h),g.appendChild(u),g.appendChild(m),g.appendChild(f),g.appendChild(y),g.appendChild(E),g.appendChild(T),g.appendChild(b),document.getElementById("tbody").appendChild(g)}else n++}else n++;break;case 1:if(c.winner)l++;else{let B=document.createElement("tr"),$=document.createElement("td"),k=document.createElement("td"),_=document.createElement("td"),v=document.createElement("td"),I=document.createElement("td"),w=document.createElement("td"),x=document.createElement("td"),M=document.createElement("td"),L=new Date(c.createdAt);$.innerText=`${d+1-l}`,k.innerHTML=`<a href="https://lichess.org/@/${p.user.id}">${p.user.title?`<b class="title"${"BOT"===p.user.title?'style="color: #b72fc6;"':""}>${p.user.title}</b> `:""}${p.user.name}</a>`,_.innerText=`${p.rating}${p.provisional?"?":""}`,v.innerText=`${o.rating}${o.provisional?"?":""}`,I.innerHTML=`<a href="https://lichess.org/@/${user.username}${"fromPosition"===c.perf?"":`/perf/${c.perf}`}">${perf(c.perf)}`,w.innerText=c.daysPerTurn?`${c.daysPerTurn} ${c.daysPerTurn>1?"days":"day"}`:c.clock?`${tc(c.clock.initial/60)}+${c.clock.increment}`:"∞",x.innerText=`${c.rated?"Yes":"No"}`,M.innerHTML=`<a href="https://lichess.org/${c.id}">${L.getFullYear()}-${1===`${L.getMonth()+1}`.length?`0${L.getMonth()+1}`:L.getMonth()+1}-${1===`${L.getDate()}`.length?`0${L.getDate()}`:L.getDate()}</a>`,B.appendChild($),B.appendChild(k),B.appendChild(_),B.appendChild(v),B.appendChild(I),B.appendChild(w),B.appendChild(x),B.appendChild(M),document.getElementById("tbody").appendChild(B)}break;case 2:if(c.winner){if(c.players[c.winner].user.id!==user.id){let H=document.createElement("tr"),D=document.createElement("td"),P=document.createElement("td"),A=document.createElement("td"),R=document.createElement("td"),Y=document.createElement("td"),O=document.createElement("td"),z=document.createElement("td"),F=document.createElement("td"),N=new Date(c.createdAt);D.innerText=`${d+1-n}`,P.innerHTML=`<a href="https://lichess.org/@/${p.user.id}">${p.user.title?`<b class="title"${"BOT"===p.user.title?'style="color: #b72fc6;"':""}>${p.user.title}</b> `:""}${p.user.name}</a>`,A.innerText=`${p.rating}${p.provisional?"?":""}`,R.innerText=`${o.rating}${o.provisional?"?":""}`,Y.innerHTML=`<a href="https://lichess.org/@/${user.username}${"fromPosition"===c.perf?"":`/perf/${c.perf}`}">${perf(c.perf)}`,O.innerText=c.daysPerTurn?`${c.daysPerTurn} ${c.daysPerTurn>1?"days":"day"}`:c.clock?`${tc(c.clock.initial/60)}+${c.clock.increment}`:"∞",z.innerText=`${c.rated?"Yes":"No"}`,F.innerHTML=`<a href="https://lichess.org/${c.id}">${N.getFullYear()}-${1===`${N.getMonth()+1}`.length?`0${N.getMonth()+1}`:N.getMonth()+1}-${1===`${N.getDate()}`.length?`0${N.getDate()}`:N.getDate()}</a>`,H.appendChild(D),H.appendChild(P),H.appendChild(A),H.appendChild(R),H.appendChild(Y),H.appendChild(O),H.appendChild(z),H.appendChild(F),document.getElementById("tbody").appendChild(H)}else n++}else n++}}}f_r.addEventListener("click",async()=>{document.getElementById("f_r").innerText=`${({Wins:"Draws",Draws:"Losses",Losses:"Wins"})[document.getElementById("f_r").innerText]}`,config.rank=({Wins:0,Draws:1,Losses:2})[document.getElementById("f_r").innerText]}),document.getElementById("fupdate").addEventListener("click",update);